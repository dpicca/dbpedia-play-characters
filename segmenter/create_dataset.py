"""
Create a dataset.


Some statistics 31.10.2018:

>>> from pprint import pprint
>>> from dhtk.catalogs.gutenberg.search_triplet_store import GutenbergSearchTripletStore
>>> gs = GutenbergSearchTripletStore(sparql_endpoint="http://dhtk.unil.ch:3030/gutenberg")

Number of books in gutenberg:
>>> len(gs.all_titles())
57988
Number of bookshelves:
>>> len(gs.all_bookshelves())
335
Compute bookshef sizes:
>>> bookshelve_size = dict()
... for b in bookshelves:
...     bookshelve_size[b] = len(gs.search_by_bookshelf(b))
... pprint(bookshelve_size)

{'Adventure': 82,
 'Africa': 119,
 'African American Writers': 40,
 "Ainslee's": 4,
 'American Revolutionary War': 5,
 'Anarchism': 13,
 'Animal': 767,
 'Animals-Domestic': 63,
 'Animals-Wild': 400,
 'Animals-Wild-Birds': 86,
 'Animals-Wild-Insects': 28,
 'Animals-Wild-Mammals': 156,
 'Animals-Wild-Reptiles and Amphibians': 46,
 'Animals-Wild-Trapping': 25,
 'Anthropology': 46,
 'Archaeology': 27,
 'Architecture': 35,
 'Argentina': 20,
 "Armour's Monthly Cook Book": 1,
 'Art': 151,
 'Arthurian Legends': 21,
 'Astounding Stories': 82,
 'Astronomy': 38,
 'Atheism': 9,
 'Australia': 130,
 "Bahá'í Faith": 37,
 "Banned Books from Anne Haight's list": 181,
 'Barnavännen': 5,
 'Best Books Ever Listings': 205,
 'Bestsellers, American, 1895-1923': 429,
 'Bibliomania': 38,
 'Biographies': 57,
 'Biology': 81,
 'Bird-Lore': 1,
 'Birds, Illustrated by Color Photography': 14,
 "Blackwood's Edinburgh Magazine": 66,
 'Boer War': 40,
 'Botany': 29,
 'British Law': 22,
 "Buchanan's Journal of Man": 0,
 'Buddhism': 12,
 'Bulgaria': 5,
 'Bulletin de Lille': 8,
 'CIA World Factbooks': 21,
 'Camping': 7,
 'Canada': 70,
 'Canon Law': 2,
 'Celtic Magazine': 6,
 "Chambers's Edinburgh Journal": 107,
 'Chemistry': 32,
 "Child's Own Book of Great Musicians": 12,
 "Children's Anthologies": 26,
 "Children's Biography": 9,
 "Children's Book Series": 511,
 "Children's Fiction": 341,
 "Children's History": 141,
 "Children's Instructional Books": 115,
 "Children's Literature": 316,
 "Children's Myths, Fairy Tales, etc.": 46,
 "Children's Picture Books": 161,
 "Children's Religion": 10,
 "Children's Verse": 20,
 'Christianity': 182,
 'Christmas': 118,
 'Classical Antiquity': 115,
 'Contemporary Reviews': 66,
 'Continental Monthly': 36,
 'Cookery': 127,
 'Crafts': 80,
 'Crime Fiction': 32,
 'Crime Nonfiction': 36,
 'Current History': 13,
 'Czech': 2,
 'DE Drama': 117,
 'DE Kinderbuch': 78,
 'DE Lyrik': 81,
 'DE Prosa': 384,
 'DE Sachbuch': 252,
 'De Aarde en haar Volken': 111,
 'Detective Fiction': 108,
 'Dew Drops': 9,
 "Donahoe's Magazine": 4,
 'Early English Text Society': 5,
 'Ecology': 5,
 'Education': 100,
 'Egypt': 53,
 'Engineering': 5,
 'English Civil War': 3,
 'Erotic Fiction': 16,
 'Esperanto': 102,
 'FR Beaux-Arts': 10,
 'FR Biographie, Mémoires, Journal intime, Correspondance': 327,
 'FR Chansons': 5,
 'FR Chroniques': 24,
 'FR Contes': 34,
 'FR Droit et Justice': 20,
 'FR Education et Enseignement': 37,
 'FR Femmes': 37,
 'FR Guerres': 38,
 'FR Histoire': 207,
 'FR Humour': 38,
 'FR Illustrateurs': 32,
 'FR Jeunesse': 91,
 'FR La Première Guerre Mondiale, 1914-1918': 17,
 'FR Langues': 44,
 'FR Littérature': 1016,
 'FR Littérature francophone': 9,
 'FR Livres, Collections et Bibliophilie': 10,
 'FR Musique': 29,
 'FR Métiers et Artisanat': 7,
 'FR Nouveautés': 70,
 'FR Nouvelles': 174,
 'FR Occultisme': 12,
 'FR Peinture': 16,
 'FR Peuples et Sociétés': 52,
 'FR Philosophie, Religion et Morale': 89,
 'FR Politique': 51,
 'FR Poésie': 113,
 'FR Presse': 4,
 'FR Prix Nobel': 2,
 'FR Science fiction': 35,
 'FR Sciences et Techniques': 157,
 'FR Services publics': 18,
 'FR Sports et loisirs': 5,
 'FR Séduction et libertinage': 40,
 'FR Théâtre': 162,
 'FR Villes': 21,
 'FR Voyages et pays': 117,
 'Famous Scots Series': 23,
 'Fantasy': 91,
 'Folklore': 64,
 'Forestry': 7,
 'France': 103,
 'Garden and Forest': 1,
 'General Fiction': 2,
 'Geology': 10,
 'German Language Books': 36,
 'Germany': 60,
 "Godey's Lady's Book": 2,
 'Golden Days for Boys and Girls': 4,
 'Gothic Fiction': 29,
 "Graham's Magazine": 12,
 'Greece': 17,
 "Harper's New Monthly Magazine": 23,
 "Harper's Young People": 83,
 'Harvard Classics': 179,
 'Hinduism': 22,
 'Historical Fiction': 383,
 'Horror': 49,
 'Horticulture': 54,
 'Humor': 144,
 'IT Agraria': 4,
 "IT Archeologia e Storia dell'arte": 2,
 'IT Architettura': 1,
 'IT Arte varia': 1,
 'IT Biografie': 18,
 'IT Botanica': 3,
 'IT Cucina': 1,
 'IT Discorsi e Orazioni': 2,
 'IT Economia': 3,
 'IT Filosofia': 4,
 'IT Folklore': 4,
 'IT Geografia': 10,
 'IT Legge': 7,
 'IT Letteratura': 33,
 'IT Letteratura per ragazzi': 7,
 'IT Linguistica': 4,
 'IT Miscellanea': 3,
 'IT Musica': 6,
 'IT Narrativa varia': 16,
 'IT Numismatica': 3,
 'IT Poesia': 46,
 'IT Psicologia e Sociologia': 5,
 'IT Racconti': 68,
 'IT Religione e Spiritualità': 10,
 'IT Romanzi': 194,
 'IT Romanzi storici': 28,
 'IT Salute': 1,
 'IT Scienza': 5,
 'IT Scienze militari': 2,
 'IT Scienze politiche': 15,
 'IT Storia': 142,
 'IT Teatro dialettale': 7,
 'IT Teatro in prosa': 69,
 'IT Teatro in versi': 13,
 'IT Tecnologia': 1,
 'IT Umorismo': 10,
 'IT Viaggi': 29,
 'Illustrators': 1,
 'India': 45,
 'Islam': 22,
 'Italy': 45,
 'Journal of Entomology and Zoology': 2,
 'Judaism': 88,
 "L'Illustration": 223,
 'Language Education': 55,
 'Latter Day Saints': 72,
 "Lippincott's Magazine": 47,
 'Little Folks': 6,
 'London Medical Gazette': 1,
 'Love': 4,
 'Manufacturing': 34,
 'Maps and Cartography': 1,
 'Masterpieces in Colour': 58,
 'Mathematics': 166,
 "McClure's Magazine": 14,
 'Medicine': 59,
 'Mediæval Town Series': 20,
 'Microbiology': 6,
 'Microscopy': 7,
 'Mother Earth': 4,
 'Movie Books': 119,
 "Mrs Whittelsey's Magazine for Mothers and Daughters": 1,
 'Music': 101,
 'Mycology': 6,
 'Mystery Fiction': 13,
 'Mythology': 16,
 'Napoleonic(Bookshelf)': 0,
 'Native America': 135,
 'Natural History': 18,
 'New Zealand': 34,
 'Northern Nut Growers Association': 0,
 'Norway': 1,
 'Notes and Queries': 219,
 'Noteworthy Trials(Bookshelf)': 0,
 'One Act Plays': 60,
 'Opera': 113,
 'Our Young Folks': 2,
 'PT Arte': 6,
 'PT Biografia': 44,
 'PT Ciência e Técnica': 10,
 'PT Contos': 33,
 'PT História': 38,
 'PT Infantil e Juvenil': 6,
 'PT Língua Portuguesa': 3,
 'PT Navegações e Explorações': 12,
 'PT Periódicos': 28,
 'PT Poesia': 81,
 'PT Política e Sociedade': 20,
 'PT Romance': 39,
 'PT Teatro': 20,
 'Paganism': 29,
 'Philosophy': 125,
 'Photography': 33,
 'Physics': 37,
 'Physiology': 23,
 'Pirates, Buccaneers, Corsairs, etc.': 84,
 'Plays': 68,
 'Poetry': 91,
 'Poetry, A Magazine of Verse': 1,
 'Politics': 32,
 'Popular Science Monthly': 2,
 'Prairie Farmer': 5,
 'Precursors of Science Fiction': 34,
 'Project Gutenberg': 18,
 'Psychology': 44,
 'Punch': 531,
 'Punchinello': 39,
 'Racism': 10,
 'Reference': 31,
 'Romantic Fiction': 6,
 'School Stories': 62,
 'Science': 1683,
 'Science Fiction': 1496,
 'Science Fiction by Women': 56,
 'Scientific American': 86,
 'Scouts': 25,
 "Scribner's Magazine": 1,
 'Short Stories': 0,
 'Slavery': 97,
 'Sociology': 48,
 'South Africa': 13,
 'South America': 14,
 'Spanish American War': 10,
 'St. Nicholas Magazine for Boys and Girls': 16,
 'Suffrage': 10,
 'Technology': 245,
 'The Aldine': 1,
 'The American Architect and Building News': 2,
 'The American Journal of Archaeology': 1,
 'The American Missionary': 125,
 'The American Quarterly Review': 1,
 'The Arena': 8,
 'The Argosy': 6,
 'The Atlantic Monthly': 116,
 'The Baptist Magazine': 4,
 'The Bay State Monthly': 24,
 'The Botanical Magazine': 9,
 'The Brochure Series of Architectural Illustration': 12,
 'The Catholic World': 5,
 'The Christian Foundation': 13,
 'The Church of England Magazine': 1,
 'The Contemporary Review': 4,
 'The Economist': 1,
 'The Esperantist': 0,
 'The Galaxy': 6,
 'The Girls Own Paper': 6,
 'The Great Round World And What Is Going On In It': 49,
 'The Haslemere Museum Gazette': 1,
 'The Idler': 5,
 'The Illustrated War News': 2,
 'The International Magazine of Literature, Art, and Science': 26,
 'The Irish Ecclesiastical Record': 0,
 'The Irish Penny Journal': 12,
 'The Journal of Negro History': 7,
 'The Knickerbocker': 15,
 'The Mayflower': 1,
 'The Menorah Journal': 1,
 'The Mentor': 3,
 'The Mirror of Literature, Amusement, and Instruction': 202,
 'The Mirror of Taste, and Dramatic Censor': 1,
 'The National Preacher': 3,
 'The North American Medical and Surgical Journal': 1,
 'The Nursery': 48,
 'The Philatelic Digital Library Project': 10,
 'The Scrap Book': 6,
 'The Speaker': 1,
 'The Stars and Stripes': 1,
 'The Strand Magazine': 13,
 'The Unpopular Review': 2,
 'The Writer': 1,
 'The Yellow Book': 0,
 'Transportation': 4,
 'Travel': 147,
 'US Civil War': 332,
 'United Kingdom': 191,
 'United States': 130,
 'United States Law': 12,
 'Western': 92,
 'Witchcraft': 15,
 "Women's Travel Journals": 11,
 'Woodwork': 14,
 'World War I': 442,
 'World War II': 70,
 'Zoology': 18}

>>> bookshelve_size = dict()
... for b in bookshelves:
...     n_books = len(gs.search_by_bookshelf(b))
...     if n_books > 20:
...         bookshelve_size[b] = n_books
... pprint(bookshelve_size)

Reduced to 171
{'Adventure': 82,
 'Africa': 119,
 'African American Writers': 40,
 'Animal': 767,
 'Animals-Domestic': 63,
 'Animals-Wild': 400,
 'Animals-Wild-Birds': 86,
 'Animals-Wild-Insects': 28,
 'Animals-Wild-Mammals': 156,
 'Animals-Wild-Reptiles and Amphibians': 46,
 'Animals-Wild-Trapping': 25,
 'Anthropology': 46,
 'Archaeology': 27,
 'Architecture': 35,
 'Art': 151,
 'Arthurian Legends': 21,
 'Astounding Stories': 82,
 'Astronomy': 38,
 'Australia': 130,
 "Bahá'í Faith": 37,
 "Banned Books from Anne Haight's list": 181,
 'Best Books Ever Listings': 205,
 'Bestsellers, American, 1895-1923': 429,
 'Bibliomania': 38,
 'Biographies': 57,
 'Biology': 81,
 "Blackwood's Edinburgh Magazine": 66,
 'Boer War': 40,
 'Botany': 29,
 'British Law': 22,
 'CIA World Factbooks': 21,
 'Canada': 70,
 "Chambers's Edinburgh Journal": 107,
 'Chemistry': 32,
 "Children's Anthologies": 26,
 "Children's Book Series": 511,
 "Children's Fiction": 341,
 "Children's History": 141,
 "Children's Instructional Books": 115,
 "Children's Literature": 316,
 "Children's Myths, Fairy Tales, etc.": 46,
 "Children's Picture Books": 161,
 'Christianity': 182,
 'Christmas': 118,
 'Classical Antiquity': 115,
 'Contemporary Reviews': 66,
 'Continental Monthly': 36,
 'Cookery': 127,
 'Crafts': 80,
 'Crime Fiction': 32,
 'Crime Nonfiction': 36,
 'DE Drama': 117,
 'DE Kinderbuch': 78,
 'DE Lyrik': 81,
 'DE Prosa': 384,
 'DE Sachbuch': 252,
 'De Aarde en haar Volken': 111,
 'Detective Fiction': 108,
 'Education': 100,
 'Egypt': 53,
 'Esperanto': 102,
 'FR Biographie, Mémoires, Journal intime, Correspondance': 327,
 'FR Chroniques': 24,
 'FR Contes': 34,
 'FR Education et Enseignement': 37,
 'FR Femmes': 37,
 'FR Guerres': 38,
 'FR Histoire': 207,
 'FR Humour': 38,
 'FR Illustrateurs': 32,
 'FR Jeunesse': 91,
 'FR Langues': 44,
 'FR Littérature': 1016,
 'FR Musique': 29,
 'FR Nouveautés': 70,
 'FR Nouvelles': 174,
 'FR Peuples et Sociétés': 52,
 'FR Philosophie, Religion et Morale': 89,
 'FR Politique': 51,
 'FR Poésie': 113,
 'FR Science fiction': 35,
 'FR Sciences et Techniques': 157,
 'FR Séduction et libertinage': 40,
 'FR Théâtre': 162,
 'FR Villes': 21,
 'FR Voyages et pays': 117,
 'Famous Scots Series': 23,
 'Fantasy': 91,
 'Folklore': 64,
 'France': 103,
 'German Language Books': 36,
 'Germany': 60,
 'Gothic Fiction': 29,
 "Harper's New Monthly Magazine": 23,
 "Harper's Young People": 83,
 'Harvard Classics': 179,
 'Hinduism': 22,
 'Historical Fiction': 383,
 'Horror': 49,
 'Horticulture': 54,
 'Humor': 144,
 'IT Letteratura': 33,
 'IT Poesia': 46,
 'IT Racconti': 68,
 'IT Romanzi': 194,
 'IT Romanzi storici': 28,
 'IT Storia': 142,
 'IT Teatro in prosa': 69,
 'IT Viaggi': 29,
 'India': 45,
 'Islam': 22,
 'Italy': 45,
 'Judaism': 88,
 "L'Illustration": 223,
 'Language Education': 55,
 'Latter Day Saints': 72,
 "Lippincott's Magazine": 47,
 'Manufacturing': 34,
 'Masterpieces in Colour': 58,
 'Mathematics': 166,
 'Medicine': 59,
 'Movie Books': 119,
 'Music': 101,
 'Native America': 135,
 'New Zealand': 34,
 'Notes and Queries': 219,
 'One Act Plays': 60,
 'Opera': 113,
 'PT Biografia': 44,
 'PT Contos': 33,
 'PT História': 38,
 'PT Periódicos': 28,
 'PT Poesia': 81,
 'PT Romance': 39,
 'Paganism': 29,
 'Philosophy': 125,
 'Photography': 33,
 'Physics': 37,
 'Physiology': 23,
 'Pirates, Buccaneers, Corsairs, etc.': 84,
 'Plays': 68,
 'Poetry': 91,
 'Politics': 32,
 'Precursors of Science Fiction': 34,
 'Psychology': 44,
 'Punch': 531,
 'Punchinello': 39,
 'Reference': 31,
 'School Stories': 62,
 'Science': 1683,
 'Science Fiction': 1496,
 'Science Fiction by Women': 56,
 'Scientific American': 86,
 'Scouts': 25,
 'Slavery': 97,
 'Sociology': 48,
 'Technology': 245,
 'The American Missionary': 125,
 'The Atlantic Monthly': 116,
 'The Bay State Monthly': 24,
 'The Great Round World And What Is Going On In It': 49,
 'The International Magazine of Literature, Art, and Science': 26,
 'The Mirror of Literature, Amusement, and Instruction': 202,
 'The Nursery': 48,
 'Travel': 147,
 'US Civil War': 332,
 'United Kingdom': 191,
 'United States': 130,
 'Western': 92,
 'World War I': 442,
 'World War II': 70}

"""

import os
import pandas as pd
from random import shuffle
from glob import glob
from dhtk.utils import download_file, url_exists
from dhtk.catalogs.gutenberg.search_triplet_store import GutenbergSearchTripletStore
from scripts.segmenter import TextSegmenter
from scripts.utils import unarchive_book

gs = GutenbergSearchTripletStore(sparql_endpoint="http://dhtk.unil.ch:3030/gutenberg")
bookshelves = gs.all_bookshelves()
extensions = ["-8.zip", ".zip", "-0.zip"]
text_segmenter = TextSegmenter()

if not glob("../original_dataset_files/*"):
    for found_book in bookshelves:
        books = gs.search_by_bookshelf(found_book)
        n_books = len(books)
        if n_books > 20:
            while books:
                shuffle(books)
                book = books.pop(0)
                book_id = book["bookid"]
                book = gs.book_from_book_id(book_id)
                if not book:
                    continue
                book_id = book_id.rsplit("/", 1)[1]
                url = "http://aleph.gutenberg.org/" + book.get_file_uri()

                shuffle(extensions)
                for extension in extensions:
                    url_ok = url + extension
                    found_url = url_exists(url_ok)
                    if found_url:
                        break
                if not found_url:
                    break
                file_path = "../original_dataset_files/" + book_id + extension
                if file_path not in glob("../original_dataset_files/*"):
                    print(url_ok, file_path)
                    raw_file_path = download_file(url_ok, file_path)
                #try:
                raw_text = unarchive_book(raw_file_path)
                #except:
                #    os.remove(raw_file_path)
                #    continue
                if not raw_text:
                    os.remove(raw_file_path)
                    continue

                part_indices, _, _ = text_segmenter.get_text_parts(raw_text)

                df = pd.DataFrame(
                    columns=[
                         'title',
                         'part_n',
                         'start',
                         'end',
                         'text',
                    ]
                )
                for i, (b, e) in enumerate(part_indices):
                     df1 = pd.DataFrame.from_dict({
                        'title': [book_id],
                        'part_n': i,
                        'start': b,
                        'end': e,
                        'text': [raw_text[b:e]],
                     })
                     df = pd.concat([df, df1])
                file_name = "../devided_texts/" + book_id + ".csv"
                print(file_name)
                df.to_csv(file_name)
                break
